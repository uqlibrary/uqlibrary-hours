<!--
Element providing an overview for current libraries working hours

##### Example

    <uqlibrary-hours></uqlibrary-hours>

    <script>
    (function () {

      window.addEventListener('polymer-ready', function() {

        var hours = document.querySelector('uqlibrary-hours');

        hours.hours = [

          ];
      });
    }());
  </script>

@element uqlibrary-hours
@blurb Element providing an overview for current libraries working hours
@status alpha
@homepage http://uqlibrary.github.io/uqlibrary-hours
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<script type="text/javascript" src="../moment/moment.js"></script>

<link rel="import" href="../uqlibrary-api/uqlibrary-api-account.html">
<link rel="import" href="../uqlibrary-api/uqlibrary-api-library-hours.html">
<link rel="import" href="../uqlibrary-menu/uqlibrary-menu.html">



<dom-module id="uqlibrary-hours">
  <link rel="import" type="css" href="../uqlibrary-elements/resources/theme/element.css">
  <link rel="import" type="css" href="uqlibrary-hours.css">

  <template>
    <uqlibrary-api-account id="account"></uqlibrary-api-account>
    <uqlibrary-api-library-hours id="hoursApi"></uqlibrary-api-library-hours>
    <!--<uqlibrary-ga id="ga" appName="Hours"></uqlibrary-ga>-->

    <paper-drawer-panel id="drawerPanel" class="drawer" drawerWidth="256px" responsiveWidth="768px">
      <paper-header-panel drawer>
        <uqlibrary-menu account="{{user}}" menu-file="../uqlibrary-elements/resources/menu/applications.json"></uqlibrary-menu>
      </paper-header-panel>

      <paper-header-panel main class="main">
        <paper-toolbar>

          <iron-a11y-keys id="a11yToolBarLeftButton" keys="space enter"
                          on-keys-pressed="a11yKeyPressed"></iron-a11y-keys>
          <paper-icon-button id="toolBarLeftButton" icon="menu" paper-drawer-toggle></paper-icon-button>
          <h1 class="flex" id="toolbar-page-title">Library hours</h1>
        </paper-toolbar>

        <div id="content" class="body-footer-container">
          <ul class="three-line-text-list">
            <li class="gap"></li>
            <!--<core-list id="list" data="{{hours}}" fit class="list-margin">-->
              <template is="dom-repeat" items="{{hours}}">
                <li class="list-item border" role="link" data-title="{{item.name}}" data-code="{{item.code}}" on-tap="itemTapHandler">
                  <div class="content layout horizontal">
                    <div class="flex">

                      <div class="line1">
                        <a id="library-{{item.code}}" target="_blank" href="{{item.url}}" title="{{item.name}}">
                          <span>{{item.name}}</span>
                        </a>
                      </div>
                      <div class="text">
                        <span class="body1">{{item.times}}</span>
                        <span hidden$={{!item.notes}}>&mdash;<span>{{item.notes}}</span></span>
                      </div>
                    </div>
                    <div class$="{{item.class}}" aria-label$="{{item.class}}">&bull;</div>
                  </div>
                </li>
          </template>
          <!--</core-list>-->
          </ul>
        </div>
        <!--<uqlibrary-persistent-footer id="persistentFooter">
          <div class="footerButtons" layout horizontal end-justified>
              <paper-button on-tap="{{viewHoursClicked}}"><a target="_blank" href="https://www.library.uq.edu.au/hours/">View hours for this week</a></paper-button>
          </div>
        </uqlibrary-persistent-footer>-->
      </paper-header-panel>

    </paper-drawer-panel>

  </template>

  <script>
    Polymer({
      // Accessibility issues fixes

      is:'uqlibrary-hours',

      properties: {
        hours: {
          type: Object,
          observer: 'hoursChanged'

        },
        autoload: Boolean
      },

      hostAttributes: {
        'class' : 'layout center'
      },

      keyboardNavigationKeys: 'space enter',

      a11yKeyPressed: function(source, event) {
        if (source.path && source.path.length > 0 && source.path[0].target) {
          source.path[0].target.fire("tap");
        }
      },


      /**
       * The `hours` attribute contains information about hours
       *
       * @property hours
       * @type Object
       */
      user: {},

      ready: function() {
        var that = this;

        this.$.account.addEventListener('uqlibrary-api-account-loaded', function(e) {
          if (e.detail.hasSession) {
            that.user = e.detail;
          }
        });

        this.$.hoursApi.addEventListener('uqlibrary-api-library-hours', function(e) {
          that.hours = e.detail;
        });
        if(!!this.autoload){
          this.$.account.get();
          this.$.hoursApi.get();
        }

        this.actionButtons = {
          footer: [
            {title: 'View hours for this week', url: 'https://www.library.uq.edu.au/hours/', id: 'weekHours'}
           ]
        };

        this.$.a11yToolBarLeftButton.target = this.$.toolBarLeftButton;
      },

      viewHoursClicked: function() {
        this.$.ga.addEvent('Week hours button clicked');
      },

      hoursChanged: function() {
        if(this.hours.length > 0 ) {
          var dayString = moment().format('YYYY-MM-DD');
          var _open, _close, _diff;
          var _now = moment();
          for(var i = 0; i < this.hours.length; i++) {
            _open = moment(dayString+ ' ' + this.hours[i].open);
            _close = moment(dayString+ ' ' + this.hours[i].close);
            _diff = _close.diff(_open, 'hours');
            this.hours[i].class = 'headline ';
            if(_diff == 24) {
              this.hours[i].times = 'Open 24 hours';
              this.hours[i].class += 'open';
            }
            else if( _diff == 0) {
              this.hours[i].times = 'Closed';
              this.hours[i].class += 'closed';

            }
            else {
              this.hours[i].times = _open.format("h:mm a") + ' - ' + _close.format("h:mm a");
              this.hours[i].class += ((_open.isBefore(_now) && _close.isAfter(_now)) ? 'open' : 'closed');
            }

            if(this.hours[i].notes) {
              this.hours[i].notes =  this.hours[i].notes.replace(/&amp;/g, '&').replace(/&ndash;/g, '-');
            }

          }
        }
        this.fire('uqlibrary-hours-loaded');
      },

      itemTapHandler: function(e, detail, sender) {
        //this.$.ga.addEvent('Library details click', sender.getAttribute('data-title'));
      }

    });
  </script>

</dom-module>